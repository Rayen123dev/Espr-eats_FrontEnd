<div class="consultation-container">

  <!-- âœ… En-tÃªte -->
  <div class="header-background-consultation">
    <div class="welcome-text">
      <h1>Bienvenue dans votre espace santÃ© ğŸ©º</h1>
      <p>Consultez vos consultations passÃ©es et en attente</p>
      <div class="actions">
        <button class="nav-btn" routerLink="/profil-nutritionnel/mon-profil">Consulter mon profil</button>
        <button class="nav-btn" routerLink="/consulter-medecin">Consulter un mÃ©decin</button>
        <button class="nav-btn" disabled>Voir mes consultations</button>
        <button class="nav-btn" routerLink="/analyse-plat">Analyser un plat</button>
      </div>
    </div>
  </div>

  <!-- âœ… Toast -->
  <div *ngIf="successMessage" [ngClass]="{ 'toast-message': true, success: successSuccess, error: !successSuccess }">
    <span class="icon">{{ successSuccess ? 'âœ…' : 'âŒ' }}</span>
    <span class="text">{{ successMessage }}</span>
    <button class="close-btn" (click)="successMessage = ''">âœ–</button>
  </div>

  <div class="consultation-content">
    <!-- âœ… Filtres -->
    <div class="filter">
      <label>Filtrer par type :</label>
      <select [(ngModel)]="selectedType" (change)="onTypeChange()">
        <option *ngFor="let type of types" [value]="type">{{ type | titlecase }}</option>
      </select>

      <label>Trier par :</label>
      <select [(ngModel)]="sortBy" (change)="onSortChange()">
        <option value="recent">Date la plus proche</option>
        <option value="oldest">Date la plus Ã©loignÃ©e</option>
      </select>

      <label>Statut :</label>
      <select [(ngModel)]="selectedStatut" (change)="onStatutChange()">
        <option *ngFor="let s of statuts" [value]="s">{{ formatStatut(s) }}</option>
      </select>
    </div>

    <!-- âœ… Liste des consultations -->
    <div class="consultation-list" *ngIf="paginatedConsultations.length > 0; else noData">
      <div *ngFor="let c of paginatedConsultations" class="consultation-card">
        <div class="consultation-header">
          <h3>ğŸ“‹ {{ c.typeConsultation | titlecase }} â€” {{ c.dateConsultation | date: 'fullDate' }} Ã  {{ c.dateConsultation | date: 'shortTime' }}</h3>
        </div>

        <div class="consultation-body">
          <div class="statut" [ngClass]="c.statut.toLowerCase()">
            <strong>Statut :</strong> {{ formatStatut(c.statut) }}
            <span *ngIf="c.statut === 'EN_ATTENTE'" class="note">ğŸ• En attente dâ€™un mÃ©decin.</span>
          </div>

          <p><strong>Message :</strong> {{ c.message || 'Aucun message.' }}</p>

          <!-- Recommandation -->
          <div *ngIf="c.statut === 'TERMINEE' && recommandations[c.id]" class="reco-card mt-3">
            <h5>Recommandation du mÃ©decin</h5>
            <p>{{ recommandations[c.id] }}</p>
          </div>

          <!-- Annulation -->
          <div *ngIf="c.statut === 'EN_ATTENTE'" class="cancel-btn-wrapper">
            <button class="cancel-btn" (click)="openConfirmationDialog(c.id)">âŒ Annuler le rendez-vous</button>
          </div>
        </div>

        <!-- VisioconfÃ©rence -->
        <a *ngIf="c.statut === 'EN_ATTENTE'" [routerLink]="['/visio', c.id]" class="join-meet-btn">
          ğŸ”— Rejoindre la visioconfÃ©rence
        </a>
      </div>

      <!-- âœ… Pagination -->
      <div class="pagination">
        <button (click)="changePage(-1)" [disabled]="currentPage === 1">â—€ PrÃ©cÃ©dent</button>
        <span>Page {{ currentPage }} / {{ totalPages() }}</span>
        <button (click)="changePage(1)" [disabled]="currentPage === totalPages()">Suivant â–¶</button>
      </div>
    </div>

    <!-- Aucune donnÃ©e -->
    <ng-template #noData>
      <p class="no-consult">Aucune consultation trouvÃ©e.</p>
    </ng-template>
  </div>

  <!-- âœ… MODALE FLOTTANTE DE CONFIRMATION -->
  <div class="modal-overlay" *ngIf="selectedConsultationIdToCancel !== null" (click)="closeConfirmDialog()">
    <div class="confirm-modal" (click)="$event.stopPropagation()">
      <div class="modal-icon">âš ï¸</div>
      <h3 class="modal-title">Confirmation</h3>
      <p class="modal-text">ÃŠtes-vous sÃ»r de vouloir annuler ce rendez-vous ?</p>
      <div class="modal-actions">
        <button class="btn-confirm" (click)="confirmAnnulation()">Oui, annuler</button>
        <button class="btn-cancel" (click)="closeConfirmDialog()">Non</button>
      </div>
    </div>
  </div>

</div>
