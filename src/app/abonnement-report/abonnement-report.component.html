<div class="billing-container">
  <!-- Header -->
  <h1 class="page-title">Tableau de Bord des Abonnements</h1>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
    <button *ngIf="!isLoading" (click)="retryFetchReport()" class="download-btn">
      Réessayer
    </button>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-spinner">
    Chargement du tableau de bord...
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!isLoading && report" class="dashboard-content">
    <!-- General Statistics Cards -->
    <div class="section stats-section">
      <h2>Statistiques Générales</h2>
      <div class="stats-cards">
        <div class="plan-details card">
          <div class="plan-info">
            <div class="plan-name">Abonnements Actifs</div>
            <div class="plan-cost">{{ report.activeSubscriptions }}</div>
          </div>
        </div>
        <div class="plan-details card">
          <div class="plan-info">
            <div class="plan-name">Abonnements en Attente</div>
            <div class="plan-cost">{{ report.pendingSubscriptions }}</div>
          </div>
        </div>
        <div class="plan-details card">
          <div class="plan-info">
            <div class="plan-name">Abonnements Bloqués</div>
            <div class="plan-cost">{{ report.blockedSubscriptions }}</div>
          </div>
        </div>
        <div class="plan-details card">
          <div class="plan-info">
            <div class="plan-name">Abonnements Expirés</div>
            <div class="plan-cost">{{ report.expiredSubscriptions }}</div>
          </div>
        </div>
        <div class="plan-details card">
          <div class="plan-info">
            <div class="plan-name">Revenu Total</div>
            <div class="plan-cost">{{ report.totalRevenue.toFixed(2) }} Dt</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      <div class="section chart-section">
        <h2>Croissance Mensuelle</h2>
        <div class="chart-container">
          <canvas
            baseChart
            [datasets]="lineChartData.datasets"
            [labels]="lineChartData.labels"
            [options]="lineChartOptions"
            [legend]="lineChartLegend"
            [type]="lineChartType"
          ></canvas>
        </div>
      </div>
      <div class="section chart-section">
        <h2>Répartition des Statuts</h2>
        <div class="chart-container">
          <canvas
            baseChart
            [datasets]="pieChartData.datasets"
            [labels]="pieChartData.labels"
            [options]="pieChartOptions"
            [legend]="pieChartLegend"
            [type]="pieChartType"
          ></canvas>
        </div>
      </div>
    </div>

    <!-- Table Section -->
    <div class="section table-section">
      <h2>Abonnements par Type et Statut</h2>
      <!-- Filters -->
      <div class="payment-method filters">
        <div class="card-info">Filtres</div>
        <div class="plan-actions">
          <div class="relative">
            <select [(ngModel)]="selectedType" (change)="onFilterChange()">
              <option value="">Tous les Types</option>
              <option *ngFor="let type of types" [value]="type">{{ type }}</option>
            </select>
            <span class="pointer-events-none">
              <i class="fas fa-chevron-down"></i>
            </span>
          </div>
          <div class="relative">
            <select [(ngModel)]="selectedStatus" (change)="onFilterChange()">
              <option value="">Tous les Statuts</option>
              <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
            </select>
            <span class="pointer-events-none">
              <i class="fas fa-chevron-down"></i>
            </span>
          </div>
          <button (click)="clearFilters()" class="download-btn reset-btn">
            Réinitialiser
          </button>
        </div>
      </div>

      <!-- Table Error Message -->
      <div *ngIf="tableErrorMessage" class="error-message">
        {{ tableErrorMessage }}
      </div>

      <!-- Table Loading Spinner -->
      <div *ngIf="isLoadingTable" class="loading-spinner">
        Chargement des abonnements...
      </div>

      <!-- Table -->
      <div *ngIf="!isLoadingTable && abonnements.length > 0" class="billing-history">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Statut</th>
              <th>Coût (Dt)</th>
              <th>Date Début</th>
              <th>Date Fin</th>
              <th>Bloqué</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let abonnement of abonnements">
              <td>{{ abonnement.idAbonnement }}</td>
              <td>{{ abonnement.typeAbonnement }}</td>
              <td>{{ abonnement.abonnementStatus }}</td>
              <td>{{ abonnement.cout.toFixed(2) }}</td>
              <td>{{ abonnement.dateDebut | date: 'shortDate' }}</td>
              <td>{{ abonnement.dateFin | date: 'shortDate' }}</td>
              <td>
                <span [ngClass]="{'text-green-500': !abonnement.isBlocked, 'text-red-500': abonnement.isBlocked}">
                  {{ abonnement.isBlocked ? 'Oui' : 'Non' }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- No Data Message -->
      <div *ngIf="!isLoadingTable && abonnements.length === 0 && !tableErrorMessage" class="no-transactions">
        <div class="no-data-icon"></div>
        <p>Aucun abonnement trouvé</p>
        <span>Veuillez sélectionner un type ou un statut.</span>
      </div>
    </div>
  </div>
</div>