<div class="dashboard-container">
  <!-- Barre de navigation -->
  <nav class="dashboard-nav">
    <div class="nav-container">
      <!-- Back button for Admin only -->
      <div class="nav-back" *ngIf="userRole === 'Admin'">
        <a href="#" routerLink="/admin-layout/gestionuser" class="back-link">
          <i class="fas fa-arrow-left"></i> <span>Retour</span>
        </a>
      </div>
      
      <!-- Main navigation -->
      <ul class="nav-menu">
        <li class="nav-item">
          <a (click)="scrollToSection('stats')" class="nav-link">
            <i class="fas fa-chart-pie"></i> Statistiques
          </a>
        </li>
        <li class="nav-item">
          <a (click)="scrollToSection('charts')" class="nav-link">
            <i class="fas fa-chart-line"></i> Graphiques
          </a>
        </li>
        <li class="nav-item" *ngIf="userRole === 'Staff' || userRole === 'Admin'">
          <a (click)="scrollToSection('plats')" class="nav-link">
            <i class="fas fa-utensils"></i> Gestion des Plats
          </a>
        </li>
        <li class="nav-item" *ngIf="userRole === 'Staff'">
          <a (click)="scrollToSection('regimes')" class="nav-link">
            <i class="fas fa-apple-alt"></i> Gestion des R√©gimes
          </a>
        </li>
        <li class="nav-item">
          <a (click)="scrollToSection('menus')" class="nav-link">
            <i class="fas fa-clipboard-list"></i> Gestion des Menus
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Titre et sous-titre -->
  <div class="dashboard-header">
    <h1 *ngIf="userRole === 'Staff'">Tableau de Bord Staff</h1>
    <p>Gestion et analyse des menus, plats et r√©gimes alimentaires</p>
  </div>
  <!-- Banni√®re de notification -->
<div *ngIf="notificationMessage" class="notification-banner" [ngClass]="{'success': notificationType === 'success', 'error': notificationType === 'error'}">
  <div class="banner-content">
    <span class="banner-icon">{{ notificationType === 'success' ? '‚úì' : '‚úó' }}</span>
    <p>{{ notificationMessage }}</p>
    <button class="btn-close" (click)="clearNotification()">√ó</button>
  </div>
</div>

  <!-- Cartes de statistiques -->
  <div class="stats-cards" id="stats">
    <div class="stat-card">
      <div class="stat-icon">üçΩÔ∏è</div>
      <div class="stat-info">
        <h3>Total Plats</h3>
        <p>{{ totalPlats }} <span>{{ totalCategories }} cat√©gories diff√©rentes</span></p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìÖ</div>
      <div class="stat-info">
        <h3>Total Menus</h3>
        <p>{{ totalMenus }} <span>{{ totalValidatedMenus }} menus valid√©s</span></p>
      </div>
    </div>
    <div class="stat-card" *ngIf="userRole === 'Staff'">
      <div class="stat-icon">üë§</div>
      <div class="stat-info">
        <h3>R√©gimes Alimentaires</h3>
        <p>{{ totalRegimes }} <span>{{ regimeTypes }} types de r√©gimes disponibles</span></p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìà</div>
      <div class="stat-info">
        <h3>Taux de Validation</h3>
        <p>{{ validationRate }}% <span>{{ validatedMenus }} sur {{ totalMenus }} menus</span></p>
      </div>
    </div>
  </div>

  <!-- Sections principales (Graphiques) -->
  <div class="main-sections" id="charts">
    <div class="section plats-distribution">
      <h2>R√©partition des plats par cat√©gorie</h2>
      <p>Distribution des diff√©rents types de plats</p>
      <div class="chart-container">
        <canvas baseChart
                [data]="barChartData"
                [options]="barChartOptions"
                [type]="barChartType">
        </canvas>
      </div>
    </div>
    <div class="section menus-weekly">
      <h2>Menus par semaine</h2>
      <p>Nombre de menus valid√©s et en attente par semaine</p>
      <div class="chart-container">
        <canvas baseChart
                [data]="lineChartData"
                [options]="lineChartOptions"
                [type]="lineChartType">
        </canvas>
      </div>
    </div>
  </div>

  <!-- Gestion des plats -->
  <div class="management-section" id="plats" *ngIf="userRole === 'Staff'|| userRole === 'Admin'">
    <h2>Gestion des Plats</h2>
    
    <div class="button-container">
      <button class="btn-add" (click)="toggleAddPlatForm()" *ngIf="userRole === 'Staff'">Ajouter un Plat</button>
      <button class="btn-pdf" (click)="generatePdfRecommendations()" aria-label="G√©n√©rer un PDF des recommandations IA">
        <i class="fas fa-file-pdf"></i> Recommandations IA
      </button>
    </div>

    <div class="form-container" *ngIf="showAddPlatForm" >
      <form [formGroup]="addPlatForm" (ngSubmit)="submitPlat()" >
        <div class="form-group">
          <label for="nom">Nom du Plat</label>
          <input type="text" id="nom" formControlName="nom" class="form-control" placeholder="Entrez le nom du plat">
          <div *ngIf="addPlatForm.get('nom')?.invalid && addPlatForm.get('nom')?.touched" class="error">
            Le nom est requis.
          </div>
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" formControlName="description" class="form-control" placeholder="Entrez une description"></textarea>
        </div>
        <div class="form-group">
          <label for="categorie">Cat√©gorie</label>
          <select id="categorie" formControlName="categorie" class="form-control">
            <option value="" disabled>S√©lectionnez une cat√©gorie</option>
            <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
          </select>
          <div *ngIf="addPlatForm.get('categorie')?.invalid && addPlatForm.get('categorie')?.touched" class="error">
            La cat√©gorie est requise.
          </div>
        </div>
        <div class="form-group">
          <label for="calories">Calories (kcal)</label>
          <input type="number" id="calories" formControlName="calories" class="form-control" placeholder="Entrez les calories">
          <div *ngIf="addPlatForm.get('calories')?.invalid && addPlatForm.get('calories')?.touched" class="error">
            Les calories doivent √™tre un nombre positif.
          </div>
        </div>
        <div class="form-group">
          <label for="image">Image du Plat</label>
          <input type="file" id="image" (change)="onFileSelected($event)" accept="image/*" class="form-control">
          <div *ngIf="imagePreview" class="image-preview">
            <img [src]="imagePreview" alt="Pr√©visualisation de l'image">
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-submit" [disabled]="addPlatForm.invalid">{{ isEditMode ? 'Modifier' : 'Ajouter' }}</button>
          <button type="button" class="btn-cancel" (click)="toggleAddPlatForm()">Annuler</button>
        </div>
      </form>
    </div>
    

    <div class="management-table">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nom</th>
            <th>Description</th>
            <th>Cat√©gorie</th>
            <th>Calories</th>
            <th>Image</th>
            <th *ngIf="userRole === 'Staff'">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let plat of  displayedPlats">
            <td>{{ plat.id }}</td>
            <td>{{ plat.nom }}</td>
            <td>{{ plat.description }}</td>
            <td>{{ plat.categorie }}</td>
            <td>{{ plat.calories }} kcal</td>
            <td>
              <img *ngIf="plat.imagePath" [src]="getImageUrl(plat.imagePath)" alt="{{plat.nom}}" class="plat-image">
            </td>
            <td>
              <button class="btn-edit" (click)="openEditPlatModal(plat)" *ngIf="userRole === 'Staff'">Modifier</button>
              <button class="btn-delete" (click)="deletePlat(plat.id)" *ngIf="userRole === 'Staff'">Supprimer</button>
            </td>
          </tr>
        </tbody>
      </table>
      <!-- Pagination pour les plats -->
   <!-- Pagination pour les plats (5 par page) -->
   <div class="pagination" *ngIf=" plats.length > itemsPerPage">
    <button class="btn-pagination" [disabled]="currentPage === 1" (click)="previousPage()">
      <span class="material-icons"></span> Pr√©c√©dent
    </button>
    <span class="page-info">Page {{ currentPage }} sur {{ totalPages }}</span>
    <button class="btn-pagination" [disabled]="currentPage === totalPages" (click)="nextPage()">
      Suivant <span class="material-icons"></span>
    </button>
  </div>
    </div>
  </div>

  
 
<!-- Gestion des r√©gimes -->
<div class="management-section" id="regimes" *ngIf="userRole === 'Staff'">
  <h2>Gestion des R√©gimes Alimentaires</h2>
  <button class="btn-add" (click)="toggleAddRegimeForm()" >Ajouter un R√©gime</button>

  <!-- Formulaire d'ajout de r√©gime -->
  <div class="form-container" *ngIf="showAddRegimeForm">
    <form [formGroup]="addRegimeForm" (ngSubmit)="submitRegime()">
      <div class="form-group">
        <label for="type">Type de R√©gime</label>
        <select id="type" formControlName="type" class="form-control">
          <option value="" disabled>S√©lectionnez un type de r√©gime</option>
          <option *ngFor="let type of regimeTypesList" [value]="type">{{ type }}</option>
        </select>
        <div *ngIf="addRegimeForm.get('type')?.invalid && addRegimeForm.get('type')?.touched" class="error">
          Le type de r√©gime est requis.
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-submit" [disabled]="addRegimeForm.invalid">Ajouter</button>
        <button type="button" class="btn-cancel" (click)="toggleAddRegimeForm()">Annuler</button>
      </div>
    </form>
  </div>


  <!-- Tableau des r√©gimes -->
  <div class="management-table">
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Plats Recommand√©s</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let regime of regimes">
          <td>{{ regime.type }}</td>
          <td>{{ regime.platsRecommandes.length || 0 }} plats</td>
          <td>
            <button class="btn-edit" (click)="openEditRegimeModal(regime)">Modifier</button>
            <button class="btn-assign" (click)="openAssignPlatsModal(regime)">Assigner Plats</button>
            <button class="btn-delete" (click)="deleteRegime(regime.id)">Supprimer</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Section des cartes de r√©gimes harmonis√©e -->
  <div class="regime-container">
    <mat-card *ngFor="let regime of regimes" class="regime-card">
      <mat-card-title (click)="toggleRegime(regime.id)" class="clickable">
        {{ regime.type }}
      </mat-card-title>
      <mat-card-content *ngIf="selectedRegimeId === regime.id">
        <p>Plats Recommand√©s :</p>
        <div class="plat-mini-cards" *ngIf="regime.platsRecommandes && regime.platsRecommandes.length > 0">
          <div class="mini-card" *ngFor="let plat of regime.platsRecommandes">
            <img class="mini-card-img" [src]="plat.imagePath" alt="{{ plat.nom }}">
            <div class="mini-card-content">
              <h4>{{ plat.nom }}</h4>
              <p>{{ plat.categorie }}</p>
              <p>{{ plat.calories }} kcal</p>
              <button class="btn-unassign" (click)="unassignPlatFromRegime(regime.id, plat.id)">D√©sassigner</button>
            </div>
          </div>
        </div>
        <p *ngIf="regime.platsRecommandes.length === 0">Aucun plat recommand√©.</p>
      </mat-card-content>
    </mat-card>
  </div>
</div>

  <!-- Gestion des Menus -->
  <div class="management-section" id="menus" *ngIf="userId && userRole && (userRole === 'Staff' || userRole === 'Medecin'|| userRole === 'Admin')">
   
    <app-menu-dashboard [userId]="userId" [userRole]="userRole"></app-menu-dashboard>
  </div>

  <!-- Modale pour assigner des plats -->
  <div class="modal" *ngIf="showAssignPlatsModal" (click)="closeAssignPlatsModal($event)">
    <div class="modal-content">
      <h3>Assigner des plats au r√©gime {{ selectedRegime?.type }}</h3>
      <div class="plat-list">
        <label *ngFor="let plat of plats">
          <input type="checkbox" 
                 [value]="plat.id" 
                 [checked]="selectedPlatIds.includes(plat.id)" 
                 (change)="togglePlatSelection(plat.id, $event)">
          {{ plat.nom }} ({{ plat.categorie }})
          <span *ngIf="plat.regimes && plat.regimes.length > 0">
            - Assign√© √† : {{ getRegimeTypes(plat.regimes) }}
          </span>
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn-submit" (click)="submitPlatAssignment()">Assigner</button>
        <button class="btn-cancel" (click)="closeAssignPlatsModal()">Annuler</button>
      </div>
    </div>
  </div>
</div>